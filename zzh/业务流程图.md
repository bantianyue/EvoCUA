# EvoCUA 业务流程文档

## 1. 总体业务流程

### 1.1 系统主流程

```
┌─────────────────────────────────────────────────────────────┐
│                     1. 系统初始化阶段                        │
├─────────────────────────────────────────────────────────────┤
│  • 加载 .env 环境变量                                       │
│  • 配置日志系统 (loguru)                                    │
│  • 解析命令行参数                                            │
│  • 初始化 LLM 客户端                                        │
└───────────────────────────┬─────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     2. 任务加载阶段                          │
├─────────────────────────────────────────────────────────────┤
│  • 读取测试配置文件 (test_nogdrive.json)                    │
│  • 过滤任务列表                                              │
│  • 创建任务队列                                              │
│  • 初始化多进程执行池                                        │
└───────────────────────────┬─────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     3. 环境准备阶段                          │
├─────────────────────────────────────────────────────────────┤
│  • 初始化 Provider (AWS/Azure等)                            │
│  • 启动/分配虚拟机实例                                       │
│  • 建立 SSH 连接                                             │
│  • 初始化 DesktopEnv                                        │
└───────────────────────────┬─────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     4. 任务执行阶段 (并行)                   │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────┐  │
│  │  4.1 单任务执行循环                                  │  │
│  │    ┌─────────────────────────────────────────────┐   │  │
│  │    │  a. 环境重置                               │   │  │
│  │    │     - 加载任务配置                         │   │  │
│  │    │     - 重置环境状态                         │   │  │
│  │    │     - 智能体重置                           │   │  │
│  │    └──────────────────┬──────────────────────────┘   │  │
│  │                       ↓                               │  │
│  │    ┌─────────────────────────────────────────────┐   │  │
│  │    │  b. 观察获取                               │   │  │
│  │    │     - 屏幕截图                             │   │  │
│  │    │     - a11y 树                             │   │  │
│  │    │     - 窗口信息                             │   │  │
│  │    └──────────────────┬──────────────────────────┘   │  │
│  │                       ↓                               │  │
│  │    ┌─────────────────────────────────────────────┐   │  │
│  │    │  c. 智能体决策                             │   │  │
│  │    │     - 处理观察                             │   │  │
│  │    │     - 构建 Prompt                          │   │  │
│  │    │     - 调用 LLM                             │   │  │
│  │    │     - 解析动作                             │   │  │
│  │    └──────────────────┬──────────────────────────┘   │  │
│  │                       ↓                               │  │
│  │    ┌─────────────────────────────────────────────┐   │  │
│  │    │  d. 动作执行                               │   │  │
│  │    │     - 点击/拖拽/输入                        │   │  │
│  │    │     - 文件操作                             │   │  │
│  │    │     - 应用控制                             │   │  │
│  │    └──────────────────┬──────────────────────────┘   │  │
│  │                       ↓                               │  │
│  │    ┌─────────────────────────────────────────────┐   │  │
│  │    │  e. 任务评估                               │   │  │
│  │    │     - 检查任务完成状态                     │   │  │
│  │    │     - 计算奖励值                           │   │  │
│  │    └──────────────────┬──────────────────────────┘   │  │
│  │                       ↓                               │  │
│  │    ┌─────────────────────────────────────────────┐   │  │
│  │    │  f. 结果记录                               │   │  │
│  │    │     - 保存轨迹数据                         │   │  │
│  │    │     - 记录成功/失败                        │   │  │
│  │    └─────────────────────────────────────────────┘   │  │
│  │                                                       │  │
│  │  g. 判断: 任务完成 or 达到最大步数?                   │  │
│  │     └─ NO ─→ 返回 b                                 │  │
│  │     └─ YES → 任务结束                                │  │
│  └───────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     5. 结果汇总阶段                          │
├─────────────────────────────────────────────────────────────┤
│  • 收集所有任务结果                                          │
│  • 计算成功率统计                                            │
│  • 生成详细报告                                              │
│  • 清理虚拟机资源                                            │
└─────────────────────────────────────────────────────────────┘
```

## 2. 单任务详细流程

### 2.1 单任务执行流程 (lib_run_single.py)

```
开始: run_single_example_evocua()
    ↓
┌───────────────────────────────────────────────────────────┐
│  步骤 1: 环境重置                                         │
├───────────────────────────────────────────────────────────┤
│  env.reset(task_config=example)                           │
│    ├── 加载任务配置 (instruction, config, eval)           │
│    ├── 重置虚拟机环境                                      │
│    │   ├── 关闭所有应用                                   │
│    │   ├── 清理临时文件                                   │
│    │   └── 重置桌面设置                                   │
│    └── 执行环境设置脚本                                    │
│        └── setup.py 根据配置准备环境                      │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  步骤 2: 智能体重置                                       │
├───────────────────────────────────────────────────────────┤
│  agent.reset()                                            │
│    ├── 清空历史记录                                        │
│    ├── 重置内部状态                                        │
│    └── 初始化任务上下文                                    │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  步骤 3: 开始记录                                         │
├───────────────────────────────────────────────────────────┤
│  env.controller.start_recording()                         │
│    └── 启动屏幕和操作录制                                  │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  步骤 4: 主循环 (执行决策)                                │
├───────────────────────────────────────────────────────────┤
│                                                           │
│  while step_idx < max_steps and not done:                 │
│                                                           │
│    4.1 获取观察                                           │
│        obs = env.get_observation()                        │
│            ├── screenshot (屏幕截图)                      │
│            ├── a11y_tree (可访问性树)                     │
│            └── window_info (窗口信息)                     │
│                                                           │
│    4.2 智能体预测                                         │
│        response, actions = agent.predict(instruction, obs)│
│            ├── 处理观察 (图像编码、resize)                 │
│            ├── 构建提示词                                  │
│            ├── 调用 LLM API                                │
│            └── 解析响应得到动作                            │
│                                                           │
│    4.3 执行动作                                           │
│        obs, reward, done, info = env.step(actions)        │
│            ├── 映射到具体 GUI 操作                         │
│            │   ├── click (点击)                           │
│            │   ├── drag (拖拽)                            │
│            │   ├── type (输入)                            │
│            │   ├── scroll (滚动)                          │
│            │   └── wait (等待)                            │
│            └── 通过 SSH 执行到虚拟机                       │
│                                                           │
│    4.4 任务评估                                           │
│        if info.get("evaluator") is not None:              │
│            result = env.evaluator.check()                 │
│                ├── 根据评估标准检查                        │
│                ├── 获取应用状态                            │
│                └── 计算完成度                              │
│                                                           │
│    4.5 更新状态                                           │
│        step_idx += 1                                      │
│        history.append((observation, action, response))    │
│                                                           │
│    4.6 判断退出条件                                       │
│        if done: break                                     │
│                                                           │
│  end while                                                │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  步骤 5: 最终评估                                         │
├───────────────────────────────────────────────────────────┤
│  final_result = env.evaluator.final_check()               │
│    ├── 执行完整的评估逻辑                                  │
│    ├── 获取所有指标                                        │
│    └── 返回成功/失败状态                                   │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  步骤 6: 结果记录                                         │
├───────────────────────────────────────────────────────────┤
│  log_result(final_result)                                  │
│    ├── 保存轨迹数据                                        │
│    ├── 记录成功/失败                                       │
│    ├── 保存截图和日志                                      │
│    └── 更新统计信息                                        │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  步骤 7: 清理资源                                         │
├───────────────────────────────────────────────────────────┤
│  env.close()                                              │
│    ├── 停止录制                                            │
│    ├── 保存录屏文件                                        │
│    └── 释放环境资源                                        │
└───────────────────────────────────────────────────────────┘
                            ↓
                          返回结果
```

## 3. 智能体决策流程

### 3.1 S1 模式 (结构化推理)

```
输入: instruction, obs, history
    ↓
┌───────────────────────────────────────────────────────────┐
│  1. 观察处理                                              │
├───────────────────────────────────────────────────────────┤
│  processed_obs = process_observation(obs)                 │
│    ├── 截图处理                                           │
│    │   ├── resize (28x28 网格)                            │
│    │   ├── encode_image() (Base64)                        │
│    │   └── 坐标转换 (qwen25 格式)                         │
│    └── a11y 树处理                                        │
│        └── 格式化为可读文本                                │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  2. 构建 S1 Prompt                                        │
├───────────────────────────────────────────────────────────┤
│  prompt = S1_SYSTEM_PROMPT + history + instruction + obs  │
│    ├── 系统提示词                                          │
│    │   └── 强调结构化推理和任务理解                        │
│    ├── 行动历史                                            │
│    │   └── 之前的观察和动作                                │
│    ├── 当前任务指令                                        │
│    └── 当前观察 (截图 + a11y)                              │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  3. LLM 推理                                              │
├───────────────────────────────────────────────────────────┤
│  response = llm_api.generate(                             │
│      prompt,                                              │
│      max_tokens=10240,                                    │
│      temperature=0.01                                     │
│  )                                                        │
│    └── EvoCUA-32B 模型生成结构化推理                       │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  4. 解析响应                                              │
├───────────────────────────────────────────────────────────┤
│  actions = parse_response(response)                       │
│    ├── 提取 reasoning (推理过程)                          │
│    ├── 提取 action (具体动作)                             │
│    └── 转换为标准动作格式                                  │
│        ├── click(x, y)                                    │
│        ├── drag(x1, y1, x2, y2)                           │
│        ├── type(text)                                     │
│        ├── scroll(direction)                              │
│        └── wait(seconds)                                  │
└───────────────────────────┬───────────────────────────────┘
                            ↓
输出: response, actions
```

### 3.2 S2 模式 (工具调用)

```
输入: instruction, obs, history
    ↓
┌───────────────────────────────────────────────────────────┐
│  1. 观察处理                                              │
├───────────────────────────────────────────────────────────┤
│  processed_obs = process_observation(obs)                 │
│    ├── 截图处理                                           │
│    │   ├── resize (32x32 网格)                            │
│    │   ├── encode_image() (Base64)                        │
│    │   └── 坐标转换 (relative 格式)                       │
│    └── a11y 树处理                                        │
│        └── 格式化为可读文本                                │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  2. 构建 S2 Prompt                                        │
├───────────────────────────────────────────────────────────┤
│  prompt = S2_SYSTEM_PROMPT + tool_defs + history + ...    │
│    ├── 系统提示词                                          │
│    │   └── 强调工具使用和精确操作                          │
│    ├── 工具定义                                            │
│    │   ├── click(x, y)                                    │
│    │   ├── drag(x1, y1, x2, y2)                           │
│    │   ├── type(text)                                     │
│    │   ├── scroll(direction)                              │
│    │   └── wait(seconds)                                  │
│    ├── 行动历史                                            │
│    ├── 当前任务指令                                        │
│    └── 当前观察                                            │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  3. LLM 工具调用                                          │
├───────────────────────────────────────────────────────────┤
│  response = llm_api.generate(                             │
│      prompt,                                              │
│      max_tokens=4096,                                     │
│      temperature=0.01                                     │
│  )                                                        │
│    └── EvoCUA-32B 生成结构化工具调用                       │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  4. 解析工具调用                                          │
├───────────────────────────────────────────────────────────┤
│  actions = parse_tool_calls(response)                     │
│    ├── 提取工具名称                                        │
│    ├── 提取参数                                            │
│    ├── 验证参数有效性                                      │
│    └── 转换为标准动作格式                                  │
└───────────────────────────┬───────────────────────────────┘
                            ↓
输出: response, actions
```

## 4. 环境管理流程

### 4.1 Provider 生命周期

```
开始: 初始化 Provider
    ↓
┌───────────────────────────────────────────────────────────┐
│  1. 认证与连接                                            │
├───────────────────────────────────────────────────────────┤
│  provider = AWSProvider()                                  │
│    ├── 加载认证信息 (AWS Credentials)                      │
│    ├── 建立连接 (boto3 client)                            │
│    └── 验证权限                                            │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  2. 启动虚拟机                                            │
├───────────────────────────────────────────────────────────┤
│  vm_info = provider.start_vm()                            │
│    ├── 选择 AMI (Ubuntu Desktop)                          │
│    ├── 配置实例类型 (GPU/CPU)                             │
│    ├── 创建安全组 (SSH/RDP 访问)                          │
│    ├── 启动实例                                            │
│    └── 获取 IP 地址和连接信息                              │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  3. 环境准备                                              │
├───────────────────────────────────────────────────────────┤
│  provider.setup_environment(vm_info)                      │
│    ├── 安装依赖 (OSWorld requirements)                     │
│    ├── 配置桌面环境                                        │
│    ├── 预装应用                                           │
│    │   ├── Chrome                                         │
│    │   ├── LibreOffice                                    │
│    │   ├── GIMP                                           │
│    │   └── 其他应用                                        │
│    └── 验证环境                                            │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  4. 执行任务 (循环)                                       │
├───────────────────────────────────────────────────────────┤
│  while has_tasks:                                         │
│    └── 运行评估任务                                        │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  5. 清理与关闭                                            │
├───────────────────────────────────────────────────────────┤
│  provider.stop_vm(vm_info)                                │
│    ├── 终止实例                                            │
│    ├── 释放资源                                            │
│    └── 记录使用统计                                        │
└───────────────────────────────────────────────────────────┘
                            ↓
                          结束
```

### 4.2 DesktopEnv 状态机

```
┌──────────────┐
│   CREATED    │ 环境已创建
└──────┬───────┘
       ↓ reset()
┌──────────────┐
│   READY      │ 准备就绪，等待任务
└──────┬───────┘
       ↓ set_task()
┌──────────────┐
│   TASK_SET   │ 任务已设置
└──────┬───────┘
       ↓ start_recording()
┌──────────────┐
│   RUNNING    │ 正在执行任务
└──────┬───────┘
       ↓ step() (循环)
┌──────────────┐
│   STEPPING   │ 执行单步动作
└──────┬───────┘
       ↓ done or error
┌──────────────┐
│  EVALUATING  │ 评估任务结果
└──────┬───────┘
       ↓
┌──────────────┐
│   FINISHED   │ 任务完成
└──────┬───────┘
       ↓ reset() or close()
┌──────────────┐
│   CLOSED     │ 环境已关闭
└──────────────┘
```

## 5. 评估流程

### 5.1 任务评估流程

```
任务完成或超时
    ↓
┌───────────────────────────────────────────────────────────┐
│  1. 触发评估                                              │
├───────────────────────────────────────────────────────────┤
│  evaluator = Evaluator(task_config["eval"])              │
│    ├── 加载评估配置                                        │
│    │   ├── eval_type (评估类型)                           │
│    │   ├── eval_data (评估数据)                           │
│    │   └── eval_method (评估方法)                         │
│    └── 初始化评估器                                        │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  2. 数据获取 (Getters)                                    │
├───────────────────────────────────────────────────────────┤
│  data = getter.get_data()                                 │
│    ├── 应用特定获取器                                      │
│    │   ├── Chrome: 浏览器历史、标签页                      │
│    │   ├── Calc: 单元格内容、公式                          │
│    │   ├── File: 文件内容、元数据                         │
│    │   ├── GIMP: 图层、编辑状态                           │
│    │   └── ...                                            │
│    └── 通用获取器                                         │
│        ├── 文件系统                                       │
│        ├── 进程列表                                       │
│        └── 窗口状态                                       │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  3. 指标计算 (Metrics)                                    │
├───────────────────────────────────────────────────────────┤
│  score = metric.calculate(data, expected)                 │
│    ├── 精确匹配                                            │
│    │   └── data == expected                               │
│    ├── 模糊匹配                                            │
│    │   └── similarity(data, expected) > threshold         │
│    ├── 包含检查                                            │
│    │   └── expected in data                               │
│    └── 自定义指标                                          │
│        └── 业务逻辑验证                                    │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  4. 结果判定                                              │
├───────────────────────────────────────────────────────────┤
│  result = {                                               │
│      "success": bool,                                     │
│      "score": float,                                      │
│      "details": {...}                                     │
│  }                                                        │
└───────────────────────────┬───────────────────────────────┘
                            ↓
                          返回结果
```

### 5.2 多任务统计流程

```
所有任务执行完成
    ↓
┌───────────────────────────────────────────────────────────┐
│  1. 收集结果                                              │
├───────────────────────────────────────────────────────────┤
│  all_results = collect_all_results()                      │
│    ├── 从各个进程/环境收集结果                             │
│    ├── 合并结果数据                                        │
│    └── 验证完整性                                          │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  2. 计算统计指标                                          │
├───────────────────────────────────────────────────────────┤
│  stats = calculate_statistics(all_results)               │
│    ├── 总任务数 (total)                                   │
│    ├── 成功任务数 (success)                               │
│    ├── 成功率 (success_rate = success / total)            │
│    ├── 按类别分组统计                                      │
│    │   ├── Chrome 任务成功率                               │
│    │   ├── LibreOffice 任务成功率                          │
│    │   ├── 系统任务成功率                                  │
│    │   └── ...                                            │
│    └── 平均步数和平均耗时                                  │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  3. 生成报告                                              │
├───────────────────────────────────────────────────────────┤
│  report = generate_report(stats)                          │
│    ├── 汇总统计信息                                        │
│    ├── 详细任务列表                                        │
│    │   └── 每个任务的成功/失败状态                         │
│    ├── 失败案例分析                                        │
│    └── 可视化图表                                          │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  4. 保存结果                                              │
├───────────────────────────────────────────────────────────┤
│  save_results(report)                                     │
│    ├── JSON 格式详细结果                                   │
│    ├── Markdown 格式报告                                   │
│    ├── 轨迹数据 (traces)                                   │
│    └── 日志文件                                            │
└───────────────────────────────────────────────────────────┘
                            ↓
                          完成
```

## 6. 并行执行流程

### 6.1 多进程执行架构

```
主进程 (Main Process)
    │
    ├── 1. 初始化
    │     ├── 加载配置
    │     ├── 读取任务列表
    │     └── 创建任务队列
    │
    ├── 2. 启动进程池
    │     ├── Process 1 ────┐
    │     ├── Process 2 ────┤
    │     ├── Process 3 ────┤
    │     ├── ...           ├── 并行执行
    │     └── Process N ────┘
    │
    └── 3. 监控与收集
           ├── 监控进程状态
           ├── 收集执行结果
           └── 处理异常情况

每个 Worker 进程:
    ├── 初始化 DesktopEnv
    ├── 创建 EvoCUAAgent
    ├── 执行单个任务 (run_single_example_evocua)
    └── 返回结果给主进程
```

### 6.2 资源调度流程

```
任务队列 (Task Queue)
    │
    ↓
┌─────────────────────────────────────┐
│  资源管理器                         │
│  ResourceManager                   │
├─────────────────────────────────────┤
│  • VM 池管理                        │
│  • 任务分发                         │
│  • 负载均衡                         │
│  • 故障恢复                         │
└───────────────┬─────────────────────┘
                ↓
    ┌───────────┴───────────┐
    ↓           ↓           ↓
  VM 1        VM 2        VM 3
  (Task 1)   (Task 2)    (Task 3)
    ↓           ↓           ↓
  完成        完成        完成
    ↓           ↓           ↓
    └───────────┴───────────┘
                ↓
         返回资源到 VM 池
```

## 7. 错误处理流程

### 7.1 异常处理机制

```
执行过程中发生异常
    ↓
┌───────────────────────────────────────────────────────────┐
│  1. 捕获异常                                              │
├───────────────────────────────────────────────────────────┤
│  try:                                                     │
│      # 执行逻辑                                           │
│  except Exception as e:                                   │
│      # 处理异常                                           │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  2. 记录错误                                              │
├───────────────────────────────────────────────────────────┤
│  log_error(e)                                             │
│    ├── 错误类型                                            │
│    ├── 错误消息                                            │
│    ├── 堆栈跟踪                                            │
│    └── 上下文信息                                          │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  3. 判断错误类型                                          │
├───────────────────────────────────────────────────────────┤
│  if isinstance(e, VMConnectionError):                     │
│      # VM 连接错误                                        │
│      retry_connection()                                   │
│  elif isinstance(e, TaskTimeoutError):                    │
│      # 任务超时                                            │
│      mark_as_failed("timeout")                            │
│  elif isinstance(e, LLMError):                            │
│      # LLM API 错误                                       │
│      retry_llm_call()                                     │
│  else:                                                    │
│      # 其他错误                                           │
│      mark_as_failed("error")                              │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  4. 恢复或终止                                            │
├───────────────────────────────────────────────────────────┤
│  if can_recover:                                          │
│      # 尝试恢复                                            │
│      retry()                                              │
│  else:                                                    │
│      # 标记失败并继续                                      │
│      cleanup_and_continue()                               │
└───────────────────────────────────────────────────────────┘
```

## 8. 日志与监控流程

### 8.1 日志记录流程

```
事件发生
    ↓
┌───────────────────────────────────────────────────────────┐
│  1. 日志分级                                              │
├───────────────────────────────────────────────────────────┤
│  • DEBUG   - 调试信息                                     │
│  • INFO    - 一般信息                                     │
│  • WARNING - 警告信息                                     │
│  • ERROR   - 错误信息                                     │
│  • CRITICAL - 严重错误                                    │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  2. 格式化日志                                            │
├───────────────────────────────────────────────────────────┤
│  log_entry = {                                            │
│      "timestamp": now(),                                  │
│      "level": log_level,                                  │
│      "source": "agent" / "env" / "evaluator",            │
│      "message": log_message,                              │
│      "context": {...}                                     │
│  }                                                        │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  3. 写入日志                                              │
├───────────────────────────────────────────────────────────┤
│  logger.log(log_entry)                                    │
│    ├── 控制台输出 (stdout)                                │
│    ├── 文件输出 (logs/*.log)                              │
│    └── 结构化存储 (JSON)                                  │
└───────────────────────────┬───────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────┐
│  4. 日志轮转                                              │
├───────────────────────────────────────────────────────────┤
│  • 文件大小限制                                            │
│  • 保留时间限制                                            │
│  • 自动压缩归档                                            │
└───────────────────────────────────────────────────────────┘
```

---

**文档版本:** 1.0
**最后更新:** 2026-01-29
**维护者:** EvoCUA Team
