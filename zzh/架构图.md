# EvoCUA 架构设计文档

## 1. 项目概述

EvoCUA 是一个基于多模态大模型的计算机使用智能体系统，专门用于 OSWorld 基准测试。该系统通过视觉理解和结构化推理，实现复杂的桌面自动化任务执行。

## 2. 整体架构

### 2.1 系统分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                     应用层 (Application Layer)               │
│                   run_multienv_evocua.py                     │
│                 (多环境并行评估主入口)                        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      智能体层 (Agent Layer)                   │
│                  mm_agents/evocua/evocua_agent.py            │
│               (EvoCUAAgent - 决策与动作生成)                  │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  S1 模式     │  │  S2 模式     │  │  工具函数     │      │
│  │ 结构化推理    │  │ 工具调用     │  │  utils.py    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    环境层 (Environment Layer)                 │
│                   desktop_env/desktop_env.py                 │
│                  (DesktopEnv - 虚拟环境管理)                  │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Providers   │  │ Controllers  │  │  Evaluators  │      │
│  │  虚拟机提供商  │  │  环境控制器   │  │  任务评估器   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    基础设施层 (Infrastructure Layer)          │
│                  云服务 (AWS/Azure/Aliyun)                    │
│                  虚拟化技术 (Docker/VMware/VirtualBox)        │
│                  LLM 服务 (vLLM + EvoCUA 模型)                │
└─────────────────────────────────────────────────────────────┘
```

## 3. 核心模块架构

### 3.1 智能体模块 (EvoCUAAgent)

```
mm_agents/evocua/
├── evocua_agent.py          # 核心智能体类
│   ├── __init__()           # 初始化 LLM 连接
│   ├── reset()              # 重置智能体状态
│   ├── predict()            # 预测下一步动作
│   ├── process_observation()  # 处理观察数据
│   └── parse_response()     # 解析 LLM 响应
│
├── prompts.py               # 提示词模板
│   ├── S1_SYSTEM_PROMPT     # 结构化推理模式提示
│   ├── S2_SYSTEM_PROMPT     # 工具调用模式提示
│   ├── ACTION_HISTORY       # 行动历史模板
│   └── TOOL_DEFINITIONS     # 工具定义
│
└── utils.py                 # 工具函数
    ├── encode_image()       # 图像编码
    ├── convert_coordinates() # 坐标转换
    └── parse_actions()      # 动作解析
```

#### 智能体工作流程

```
┌─────────────┐
│ 观察输入    │  截图、a11y树、指令
└──────┬──────┘
       ↓
┌─────────────┐
│ 图像处理    │  resize、编码
└──────┬──────┘
       ↓
┌─────────────┐
│ 提示构建    │  S1/S2 模式选择
└──────┬──────┘
       ↓
┌─────────────┐
│ LLM 推理    │  调用 EvoCUA 模型
└──────┬──────┘
       ↓
┌─────────────┐
│ 响应解析    │  提取动作指令
└──────┬──────┘
       ↓
┌─────────────┐
│ 动作输出    │  GUI 操作
└─────────────┘
```

### 3.2 环境模块 (DesktopEnv)

```
desktop_env/
├── desktop_env.py           # 主环境类
│   ├── __init__()           # 环境初始化
│   ├── reset()              # 任务重置
│   ├── step()               # 执行动作
│   └── get_observation()    # 获取观察
│
├── providers/               # 虚拟机提供商
│   ├── base.py              # 基础接口
│   ├── aws/                 # AWS 实现
│   ├── azure/               # Azure 实现
│   ├── docker/              # Docker 实现
│   ├── aliyun/              # 阿里云实现
│   └── volcengine/          # 火山引擎实现
│
├── controllers/             # 环境控制器
│   ├── python.py            # Python 代码执行
│   └── setup.py             # 环境设置
│
├── evaluators/              # 任务评估器
│   ├── getters/             # 数据获取器
│   │   ├── chrome.py        # Chrome 相关
│   │   ├── file.py          # 文件系统
│   │   ├── calc.py          # 计算器
│   │   └── ...
│   └── metrics/             # 评估指标
│       ├── basic_os.py      # 基础 OS 指标
│       ├── chrome.py        # Chrome 指标
│       └── ...
│
└── actions.py               # 动作定义
```

#### 环境管理架构

```
┌──────────────────────────────────────┐
│       DesktopEnv (统一接口)           │
├──────────────────────────────────────┤
│  ┌────────────────────────────────┐  │
│  │   Provider Manager             │  │
│  │  (虚拟机提供商管理)              │  │
│  ├────────────────────────────────┤  │
│  │  AWS │ Azure │ Docker │ Aliyun │  │
│  └────────────────────────────────┘  │
│  ┌────────────────────────────────┐  │
│  │   Controller Manager           │  │
│  │  (环境控制器)                   │  │
│  ├────────────────────────────────┤  │
│  │  Python │ Setup                │  │
│  └────────────────────────────────┘  │
│  ┌────────────────────────────────┐  │
│  │   Evaluator Manager            │  │
│  │  (任务评估器)                   │  │
│  ├────────────────────────────────┤  │
│  │  Getters │ Metrics             │  │
│  └────────────────────────────────┘  │
└──────────────────────────────────────┘
                ↓
┌──────────────────────────────────────┐
│      虚拟桌面环境 (VM/Container)      │
│  - Ubuntu Desktop                    │
│  - 预装应用 (Chrome, LibreOffice等)   │
│  - OSWorld 评估环境                  │
└──────────────────────────────────────┘
```

### 3.3 执行流程模块

```
主入口 (run_multienv_evocua.py)
│
├── 参数解析与配置
│   ├── 环境变量加载
│   ├── 命令行参数解析
│   └── 日志系统初始化
│
├── 任务管理
│   ├── 读取测试配置
│   ├── 创建任务队列
│   └── 分发任务到进程池
│
└── 多进程执行
    ├── 初始化 DesktopEnv
    ├── 创建 EvoCUAAgent
    ├── 调用 lib_run_single.py
    └── 结果汇总与记录
```

## 4. 数据流架构

### 4.1 智能体-环境交互流

```
┌──────────────┐                    ┌──────────────┐
│   Agent      │                    │   Environment│
│  EvoCUAAgent │                    │  DesktopEnv  │
└──────┬───────┘                    └──────┬───────┘
       │                                   │
       │  1. instruction + obs             │
       │ ──────────────────────────────>   │
       │                                   │
       │  2. process_observation()         │
       │     (图像编码、resize)             │
       │                                   │
       │  3. build_prompt()                │
       │     (S1/S2 模式)                  │
       │                                   │
       │  4. LLM API call                  │
       │     (获取动作)                     │
       │                                   │
       │  5. parse_response()              │
       │     (解析动作)                     │
       │                                   │
       │  6. actions                       │
       │ <───────────────────────────────  │
       │                                   │
       │                                   │  7. step(actions)
       │                                   │     (执行动作)
       │                                   │
       │  8. obs + reward + done + info    │
       │ <───────────────────────────────  │
       │                                   │
       └───────────────────────────────────┘
```

### 4.2 数据处理流

```
原始数据 (Raw Data)
    ↓
┌─────────────────┐
│  观察获取       │  screenshot, a11y_tree
└────────┬────────┘
         ↓
┌─────────────────┐
│  预处理         │  resize, encode
└────────┬────────┘
         ↓
┌─────────────────┐
│  特征提取       │  图像理解
└────────┬────────┘
         ↓
┌─────────────────┐
│  LLM 推理       │  决策生成
└────────┬────────┘
         ↓
┌─────────────────┐
│  动作映射       │  坐标转换、工具调用
└────────┬────────┘
         ↓
执行输出 (Actions)
```

## 5. 技术栈架构

### 5.1 核心依赖

```
┌─────────────────────────────────────┐
│  深度学习框架                        │
│  - PyTorch (2.5.0)                  │
│  - Transformers (4.35.2)            │
│  - Accelerate                       │
└─────────────────────────────────────┘
             ↓
┌─────────────────────────────────────┐
│  多模态处理                          │
│  - Pillow (11.0.0)                  │
│  - OpenCV                           │
│  - ImageHash                        │
└─────────────────────────────────────┘
             ↓
┌─────────────────────────────────────┐
│  GUI 自动化                          │
│  - PyAutoGUI (0.9.54)               │
│  - PyInput (1.7.6)                  │
│  - PyGetWindow                      │
└─────────────────────────────────────┘
             ↓
┌─────────────────────────────────────┐
│  云服务集成                          │
│  - boto3 (AWS)                      │
│  - azure-identity                   │
│  - docker                           │
└─────────────────────────────────────┘
```

### 5.2 部署架构

```
开发/运行环境
    ↓
┌─────────────────────────────────────┐
│  本地代码库 (EvoCUA)                 │
└────────┬────────────────────────────┘
         ↓
┌─────────────────────────────────────┐
│  vLLM 服务端                         │
│  - 部署 EvoCUA-32B 模型              │
│  - 提供 OpenAI 兼容 API              │
│  - tensor-parallel-size=2            │
└────────┬────────────────────────────┘
         ↓
┌─────────────────────────────────────┐
│  云 VM 环境                          │
│  - AWS/Azure/Aliyun                 │
│  - Ubuntu Desktop with GUI           │
│  - 预装 OSWorld 评估应用             │
└─────────────────────────────────────┘
```

## 6. 模块间依赖关系

### 6.1 依赖图

```
run_multienv_evocua.py
    │
    ├── lib_run_single.py
    │       ├── EvoCUAAgent (mm_agents/evocua/)
    │       │       ├── evocua_agent.py
    │       │       ├── prompts.py
    │       │       └── utils.py
    │       │
    │       └── DesktopEnv (desktop_env/)
    │               ├── providers/
    │               ├── controllers/
    │               ├── evaluators/
    │               └── actions.py
    │
    └── lib_results_logger.py
            └── 结果汇总与记录
```

### 6.2 接口定义

**Agent 接口:**
- `reset()` - 重置智能体状态
- `predict(instruction, obs)` - 预测动作

**Environment 接口:**
- `reset(task_config)` - 重置环境到任务初始状态
- `step(action)` - 执行动作并返回新状态
- `get_observation()` - 获取当前观察

**Provider 接口:**
- `start_vm()` - 启动虚拟机
- `stop_vm()` - 停止虚拟机
- `get_vm_connection()` - 获取连接

## 7. 配置架构

### 7.1 配置层级

```
环境变量 (.env)
    ├── AWS/Azure 认证信息
    ├── LLM API 配置
    └── 日志路径
        ↓
命令行参数
    ├── --provider_name (云提供商)
    ├── --observation_type (观察类型)
    ├── --model (模型名称)
    ├── --prompt_style (S1/S2)
    ├── --max_steps (最大步数)
    └── --num_envs (并行环境数)
        ↓
任务配置文件 (JSON)
    ├── task_id
    ├── instruction
    ├── config (环境设置)
    └── eval (评估标准)
```

### 7.2 S1 vs S2 模式配置

**S1 模式 (结构化推理):**
- `coordinate_type`: qwen25
- `max_tokens`: 10240
- `resize_factor`: 28
- `max_history_turns`: 3
- 特点：适合复杂推理任务

**S2 模式 (工具调用):**
- `coordinate_type`: relative (32x32 网格)
- `max_tokens`: 4096
- `resize_factor`: 32
- `max_history_turns`: 4
- 特点：适合精确工具操作

## 8. 扩展性设计

### 8.1 Provider 扩展

添加新的虚拟机提供商：
```python
# 继承 base.py 中的 Provider 基类
class NewProvider(Provider):
    def start_vm(self): ...
    def stop_vm(self): ...
    # 实现必需的接口方法
```

### 8.2 Agent 扩展

添加新的智能体：
```python
# 在 mm_agents/ 下创建新目录
# 实现 predict() 和 reset() 方法
class NewAgent:
    def predict(self, instruction, obs): ...
    def reset(self): ...
```

### 8.3 Evaluator 扩展

添加新的应用评估器：
```python
# 在 evaluators/getters/ 或 metrics/ 下添加新文件
# 实现应用特定的数据获取和评估逻辑
```

## 9. 安全与隔离

```
┌─────────────────────────────────────┐
│  宿主机 (运行 EvoCUA 代码)           │
└────────┬────────────────────────────┘
         │  SSH / API
         ↓
┌─────────────────────────────────────┐
│  虚拟机 (隔离的执行环境)             │
│  - 独立的操作系统                    │
│  - 网络隔离                          │
│  - 资源限制                          │
└─────────────────────────────────────┘
```

## 10. 监控与日志

```
日志系统 (loguru)
    ├── 执行日志 (logs/)
    │   ├── agent_trace.log
    │   ├── env_trace.log
    │   └── error.log
    └── 结果记录 (lib_results_logger.py)
        ├── 任务完成情况
        ├── 成功率统计
        └── 详细轨迹数据
```

---

**文档版本:** 1.0
**最后更新:** 2026-01-29
**维护者:** EvoCUA Team
